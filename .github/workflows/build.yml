name: Build Firmware & Draw Keymap
on:
  workflow_dispatch:
  push:
    paths:
      - "boards/*"
      - "config/*"

permissions:
  contents: write

jobs:
  # JOB 1: Build Firmware
  build:
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main

  # JOB 2: Draw Keymap (Manual Mode with Fix)
  draw:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Keymap Drawer
        run: pipx install keymap-drawer

      - name: Generate SVG
        run: |
          mkdir -p img
          
          # 1. Parse the ZMK file
          keymap -c config/keymap_drawer.config.yaml parse -z config/cornix.keymap > cornix_parsed.yaml
          
          # 2. Draw the SVG (Explicitly pointing to the JSON layout)
          keymap -c config/keymap_drawer.config.yaml draw cornix_parsed.yaml -j config/cornix.json > img/cornix.svg

      - name: Upload Keymap Image
        uses: actions/upload-artifact@v4
        with:
          name: keymap-drawer
          path: img/cornix.svg

      - name: Commit Keymap Update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Draw keymap graphic [skip ci]"
          file_pattern: "img/*.svg"

  # JOB 3: Combine Everything
  combine:
    needs: [build, draw]
    runs-on: ubuntu-latest
    name: Package Assets
    steps:
      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware
          path: artifacts/firmware

      - name: Download Keymap Image
        uses: actions/download-artifact@v4
        with:
          name: keymap-drawer
          path: artifacts/image

      - name: Prepare Release Folder
        run: |
          mkdir release_package
          cp artifacts/firmware/* release_package/
          cp artifacts/image/cornix.svg release_package/

      - name: Upload Combined Package
        uses: actions/upload-artifact@v4
        with:
          name: Firmware-and-Keymap
          path: release_package/